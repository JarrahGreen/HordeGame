
package org.example.scene;

import javax.imageio.ImageIO;
import java.awt.*;
import java.awt.event.KeyEvent;
import java.awt.image.BufferedImage;
import java.io.IOException;
import java.util.ArrayList;
import java.util.Objects;

import org.example.GamePanel;
import org.example.KeyHandler;
import org.example.SceneManager;
import org.example.entity.Enemy;
import org.example.entity.Player;
import org.example.entity.PlayerTwo;
import org.example.entity.powerup.Powerup;
import org.example.entity.powerup.SpeedBoost;
import org.example.entity.Projectiles.Projectiles;
import org.example.entity.Projectiles.Bullet;


public class GameScene extends Scene {
    private final BufferedImage background;

    ArrayList<Enemy> enemyList = new ArrayList<>();
    ArrayList<Projectiles> projectileList = new ArrayList<>();
    ArrayList<Projectiles> projectilesToRemove = new ArrayList<>();
    ArrayList<Powerup> powerUpList = new ArrayList<Powerup>();

    PlayerOne player = new PlayerOne(KeyHandler);

    public GameScene() {
        try {
            background = ImageIO.read(Objects.requireNonNull(getClass().getResourceAsStream("/Background.png")));
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
    }

    @Override
    public void update() {

        Enemy e1 = new Enemy(300, 300);
        Enemy e2 = new Enemy(700, 600);

        enemyList.add(e1);
        enemyList.add(e2);

        int speedBoostX = (int) (Math.random() * 500);
        int speedBoostY = (int) (Math.random() * 500);
        powerUpList.add(new SpeedBoost(speedBoostX, speedBoostY));

        boolean didHit = false;
        for(Enemy e: enemyList) {
            didHit = player.hit(e);
            if(didHit) {
                SceneManager.getSceneManager().setActiveScene(GameOverScene);
            }
        }


        for (Projectiles p: projectileList) {
            if (p.x > 768 || p.x < -20 || p.y > 576 || p.y < -20) {
                projectilesToRemove.add(p);
            }
            p.update();
        }
        projectileList.removeAll(projectilesToRemove);
        projectilesToRemove.clear();

        player.update();
        if (KeyHandler.twoPlayerSelected) {
            playerTwo.update();
        }

        // Change the Enemy's x and y location
        for (Enemy e : enemyList) {
            e.updateValues(player.x, player.y);

            //enemyXY.add(player.x, player.y);
        }

        ArrayList<Powerup> toRemove = new ArrayList<>();

        for (Powerup p : powerUpList) {
            // Is the player on top of the PowerUp
            if (player.x < p.x + p.radius && player.x + tileSize > p.x - p.radius
                    && player.y < p.y + p.radius && player.y + tileSize > p.y - p.radius) {
                p.collect(player);
                toRemove.add(p);

            }
            if (playerTwo.x < p.x + p.radius && playerTwo.x + tileSize > p.x - p.radius
                    && playerTwo.y < p.y + p.radius && playerTwo.y + tileSize > p.y - p.radius) {
                p.collect(playerTwo);
                toRemove.add(p);
            }
        // Remove powerUps from the screen that the player collects
        powerUpList.removeAll(toRemove);
        }
    }

    @Override
    public void draw(Graphics g) {
        g.drawImage(background, 0, 0, null);
        g.drawImage(background, 0, 0, null);

        player.draw(g, tileSize);

        if (twoPlayerSelected) {
            playerTwo.draw(g, tileSize);
        }

        for (Powerup powerup : powerUpList) {
            powerup.draw(g);
        }

        // Draw the enemy's
        for (Enemy e : enemyList) {
            e.draw(g, tileSize);
        }

        for (Projectiles p : projectileList) {
            p.draw(g);
        }
    }
    g.dispose();

    @Override
    public void keyPressed(KeyEvent e) {
        if (keyH.spawnBullet) {
            Bullet bullet = new Bullet(player.x, player.y, Direction.fromBooleans(
                    keyH.wPressed,
                    keyH.dPressed,
                    keyH.sPressed,
                    keyH.aPressed
            ));
            projectileList.add(bullet);
            keyH.spawnBullet = false;
        }

    }
}

		    // Key handler and Game thread
    KeyHandler keyH = new KeyHandler();
    Thread gameThread;

    // Enemy Array
    ArrayList<Enemy> enemyList = new ArrayList<>();

    ArrayList<Projectiles> projectileList = new ArrayList<>();
    ArrayList<Projectiles> projectilesToRemove = new ArrayList<>();

